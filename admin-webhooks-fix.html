<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DictaMed - Fix Admin Webhooks</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e5e5;
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß DictaMed - Fix Admin Webhooks</h1>
            <p>Page de correction et diagnostic pour l'interface d'administration des webhooks</p>
        </div>
        
        <div id="status" class="status info">
            ‚ÑπÔ∏è Pr√™t pour l'initialisation du syst√®me...
        </div>
        
        <div class="button-group">
            <button class="btn btn-primary" onclick="initializeSystem()">
                üöÄ Initialiser le Syst√®me
            </button>
            <button class="btn btn-info" onclick="runDiagnostics()">
                üîç Diagnostics Complets
            </button>
            <button class="btn btn-success" onclick="forceUserDetection()">
                ‚ö° D√©tection Forc√©e Utilisateurs
            </button>
            <button class="btn btn-warning" onclick="refreshData()">
                üîÑ Rafra√Æchir les Donn√©es
            </button>
            <button class="btn btn-danger" onclick="resetSystem()">
                üóëÔ∏è Reset Complet
            </button>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Traitement en cours...</p>
        </div>
        
        <div class="stats-grid" id="stats">
            <!-- Les statistiques seront ins√©r√©es ici -->
        </div>
        
        <div class="log" id="log">
=== LOG DU SYST√àME ===

Pr√™t pour l'initialisation...

        </div>
        
        <div class="status info">
            <h3>üìã Instructions d'utilisation:</h3>
            <ol>
                <li><strong>Initialiser le Syst√®me</strong> - Lance l'initialisation compl√®te avec le bridge d'authentification</li>
                <li><strong>Diagnostics Complets</strong> - Analyse d√©taill√©e de tous les composants</li>
                <li><strong>D√©tection Forc√©e</strong> - Force la d√©tection et le chargement des utilisateurs</li>
                <li><strong>Rafra√Æchir les Donn√©es</strong> - Recharge les donn√©es depuis Firestore</li>
                <li><strong>Reset Complet</strong> - R√©initialise compl√®tement le syst√®me</li>
            </ol>
        </div>
    </div>

    <!-- Scripts Firebase (remplacez par vos vraies configurations) -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // Configuration Firebase (√† remplacer par vos vraies valeurs)
        const firebaseConfig = {
            // Remplacez par votre configuration Firebase
            apiKey: "demo-key",
            authDomain: "dictamed-demo.firebaseapp.com",
            projectId: "dictamed-demo",
            storageBucket: "dictamed-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "demo-app-id"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);

        // Variables globales
        let isInitialized = false;

        // Fonctions utilitaires
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `\n[${timestamp}] ${message}`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function showLoading(show) {
            const loadingDiv = document.getElementById('loading');
            loadingDiv.style.display = show ? 'block' : 'none';
        }

        function updateStats() {
            const statsDiv = document.getElementById('stats');
            const bridge = window.AuthManagerBridge;
            
            if (bridge && bridge.adminWebhookManager) {
                const adminManager = bridge.adminWebhookManager;
                const userCount = adminManager.users?.length || 0;
                const webhookCount = adminManager.webhooks?.size || 0;
                const activeWebhooks = Array.from(adminManager.webhooks?.values() || [])
                    .filter(w => w?.isActive).length;

                statsDiv.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${userCount}</div>
                        <div class="stat-label">Utilisateurs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${webhookCount}</div>
                        <div class="stat-label">Webhooks Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${activeWebhooks}</div>
                        <div class="stat-label">Webhooks Actifs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${isInitialized ? '‚úÖ' : '‚ùå'}</div>
                        <div class="stat-label">Syst√®me Initialis√©</div>
                    </div>
                `;
            } else {
                statsDiv.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">-</div>
                        <div class="stat-label">Donn√©es indisponibles</div>
                    </div>
                `;
            }
        }

        // Fonctions principales
        async function initializeSystem() {
            showLoading(true);
            updateStatus('üöÄ Initialisation du syst√®me en cours...', 'info');
            log('D√©but de l\'initialisation du syst√®me...');

            try {
                // Charger les scripts n√©cessaires
                await loadScripts([
                    'auth-bridge.js',
                    'user-list-diagnostic.js',
                    'webhook-permissions-test.js',
                    'js/components/enhanced-firebase-auth-manager.js',
                    'js/components/admin-webhook-manager-enhanced-firestore.js'
                ]);

                log('Scripts charg√©s avec succ√®s');

                // Initialiser le syst√®me via le bridge
                const result = await window.initAuthSystem();
                
                if (result) {
                    isInitialized = true;
                    updateStatus('‚úÖ Syst√®me initialis√© avec succ√®s!', 'success');
                    log('‚úÖ Syst√®me initialis√© avec succ√®s');
                    updateStats();
                } else {
                    updateStatus('‚ö†Ô∏è Initialisation partielle du syst√®me', 'warning');
                    log('‚ö†Ô∏è Initialisation partielle - V√©rifiez les logs pour plus de d√©tails');
                }

            } catch (error) {
                updateStatus(`‚ùå Erreur d'initialisation: ${error.message}`, 'error');
                log(`‚ùå Erreur d'initialisation: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        async function runDiagnostics() {
            showLoading(true);
            updateStatus('üîç Lancement des diagnostics...', 'info');
            log('D√©but des diagnostics complets...');

            try {
                // Lancer le diagnostic de la liste des utilisateurs
                if (window.UserListDiagnostic) {
                    const diagnostic = new window.UserListDiagnostic();
                    await diagnostic.runFullDiagnostic();
                    updateStatus('‚úÖ Diagnostics termin√©s - Consultez la console', 'success');
                } else {
                    updateStatus('‚ö†Ô∏è Outil de diagnostic non disponible', 'warning');
                }

            } catch (error) {
                updateStatus(`‚ùå Erreur lors des diagnostics: ${error.message}`, 'error');
                log(`‚ùå Erreur diagnostics: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        async function forceUserDetection() {
            showLoading(true);
            updateStatus('‚ö° D√©tection forc√©e des utilisateurs...', 'info');
            log('D√©but de la d√©tection forc√©e...');

            try {
                const bridge = window.AuthManagerBridge;
                if (bridge) {
                    const result = await bridge.forceUserDetection();
                    if (result) {
                        updateStatus('‚úÖ D√©tection forc√©e termin√©e', 'success');
                        log('‚úÖ D√©tection forc√©e termin√©e avec succ√®s');
                    } else {
                        updateStatus('‚ö†Ô∏è D√©tection forc√©e √©chou√©e', 'warning');
                        log('‚ö†Ô∏è D√©tection forc√©e √©chou√©e');
                    }
                    updateStats();
                } else {
                    updateStatus('‚ùå Bridge non initialis√©', 'error');
                    log('‚ùå Bridge d\'authentification non initialis√©');
                }

            } catch (error) {
                updateStatus(`‚ùå Erreur lors de la d√©tection: ${error.message}`, 'error');
                log(`‚ùå Erreur d√©tection: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        async function refreshData() {
            showLoading(true);
            updateStatus('üîÑ Rafra√Æchissement des donn√©es...', 'info');
            log('D√©but du rafra√Æchissement des donn√©es...');

            try {
                const bridge = window.AuthManagerBridge;
                if (bridge) {
                    const result = await bridge.refreshData();
                    if (result) {
                        updateStatus('‚úÖ Donn√©es rafra√Æchies avec succ√®s', 'success');
                        log('‚úÖ Donn√©es rafra√Æchies avec succ√®s');
                    } else {
                        updateStatus('‚ö†Ô∏è √âchec du rafra√Æchissement', 'warning');
                        log('‚ö†Ô∏è √âchec du rafra√Æchissement');
                    }
                    updateStats();
                } else {
                    updateStatus('‚ùå Bridge non initialis√©', 'error');
                    log('‚ùå Bridge d\'authentification non initialis√©');
                }

            } catch (error) {
                updateStatus(`‚ùå Erreur lors du rafra√Æchissement: ${error.message}`, 'error');
                log(`‚ùå Erreur rafra√Æchissement: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        async function resetSystem() {
            if (!confirm('√ätes-vous s√ªr de vouloir r√©initialiser compl√®tement le syst√®me ?')) {
                return;
            }

            showLoading(true);
            updateStatus('üóëÔ∏è Reset du syst√®me en cours...', 'warning');
            log('D√©but du reset complet du syst√®me...');

            try {
                // Nettoyer les listeners
                const bridge = window.AuthManagerBridge;
                if (bridge && bridge.adminWebhookManager) {
                    bridge.adminWebhookManager.cleanup();
                }

                // R√©initialiser les variables
                isInitialized = false;
                
                // Recharger la page pour un reset complet
                setTimeout(() => {
                    location.reload();
                }, 2000);

                updateStatus('‚úÖ Reset termin√© - Rechargement en cours...', 'success');
                log('‚úÖ Reset termin√© - Rechargement de la page...');

            } catch (error) {
                updateStatus(`‚ùå Erreur lors du reset: ${error.message}`, 'error');
                log(`‚ùå Erreur reset: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // Fonction pour charger les scripts dynamiquement
        function loadScripts(urls) {
            return Promise.all(urls.map(url => {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = resolve;
                    script.onerror = () => {
                        log(`‚ö†Ô∏è Impossible de charger: ${url}`);
                        resolve(); // Continue m√™me si un script √©choue
                    };
                    document.head.appendChild(script);
                });
            }));
        }

        // Initialisation automatique
        window.addEventListener('load', () => {
            log('Page de diagnostic charg√©e');
            updateStatus('Page de diagnostic pr√™te - Cliquez sur "Initialiser le Syst√®me"', 'info');
        });

        // Mettre √† jour les stats toutes les 5 secondes
        setInterval(updateStats, 5000);
    </script>
</body>
</html>