# ğŸ¯ Guide de DÃ©ploiement - SystÃ¨me de Webhooks Uniques par Utilisateur DictaMed

## ğŸ“‹ Vue d'Ensemble

Ce guide dÃ©crit le dÃ©ploiement complet du systÃ¨me de webhooks uniques par utilisateur pour DictaMed. Chaque utilisateur authentifiÃ© aura maintenant un webhook personnalisÃ© assignÃ© par l'administrateur.

## ğŸ”§ PrÃ©requis

### Firebase Configuration
- Projet Firebase `dictamed-2025` configurÃ©
- Firebase Authentication activÃ©
- Firestore Database activÃ©
- RÃ¨gles de sÃ©curitÃ© dÃ©ployÃ©es

### Code DÃ©ployÃ©
- âœ… `js/components/webhook-manager.js` - Gestionnaire de webhooks
- âœ… `js/core/config.js` - Configuration mise Ã  jour
- âœ… `js/components/data-sender.js` - Envoi dynamique
- âœ… `firestore.rules` - RÃ¨gles de sÃ©curitÃ©
- âœ… `webhook-admin.js` - Script d'administration

## ğŸš€ Ã‰tapes de DÃ©ploiement

### Phase 1 : Configuration Firebase (30 minutes)

#### 1.1 Activer Firestore Database
```bash
# Via la console Firebase
1. Aller sur console.firebase.google.com
2. SÃ©lectionner le projet dictamed-2025
3. Firestore Database > CrÃ©er une base de donnÃ©es
4. Mode Production
5. Localisation: europe-west (France)
```

#### 1.2 DÃ©ployer les RÃ¨gles de SÃ©curitÃ©
```bash
# Utiliser Firebase CLI
firebase deploy --only firestore:rules

# Ou via la console Firebase
# Firestore Database > RÃ¨gles > Coller le contenu de firestore.rules > Publier
```

#### 1.3 VÃ©rifier la Configuration
```javascript
// Tester dans la console Firebase
firebase.firestore().collection('userWebhooks').doc('test').set({
    webhookUrl: 'https://example.com/test',
    isActive: true,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
});
```

### Phase 2 : DÃ©ploiement du Code (15 minutes)

#### 2.1 Copier les Fichiers
```bash
# Assurer que tous les fichiers sont prÃ©sents:
js/components/webhook-manager.js
js/core/config.js (mis Ã  jour)
js/components/data-sender.js (mis Ã  jour)
webhook-admin.js (pour l'admin)
```

#### 2.2 VÃ©rifier l'Inclusion dans l'Application
```html
<!-- Ajouter dans index.html si pas dÃ©jÃ  prÃ©sent -->
<script src="js/components/webhook-manager.js"></script>
```

#### 2.3 Tester en Mode DÃ©veloppement
```javascript
// Dans la console du navigateur
console.log('WebhookManager disponible:', typeof WebhookManager);
console.log('Configuration:', window.APP_CONFIG);
```

### Phase 3 : Configuration des Utilisateurs (45 minutes)

#### 3.1 AccÃ©der au Script d'Administration
```javascript
// Dans la console Firebase > Functions > Logs
// Ou crÃ©er une page d'administration temporaire
<script src="webhook-admin.js"></script>
<script>
    // Charger le script d'admin
    WebhookAdmin.showUsageInstructions();
</script>
```

#### 3.2 Identifier les Utilisateurs Actuels
```javascript
// Lister tous les utilisateurs
const users = await firebase.auth().listUsers();
console.log('Utilisateurs trouvÃ©s:', users.users.length);

// Ou utiliser la console Firebase
// Authentication > Users
```

#### 3.3 Assigner les Webhooks
```javascript
// Exemple: Assigner les webhooks par dÃ©faut Ã  un utilisateur
await WebhookAdmin.assignDefaultWebhooks('USER_UID_HERE', 'MÃ©decin - Cabinet principal');

// Ou webhooks personnalisÃ©s
await WebhookAdmin.assignWebhookToUser(
    'USER_UID_HERE',
    'https://n8n.srv1104707.hstgr.cloud/webhook/DrMartinCabinet',
    true,
    'Dr. Martin - Cabinet principal'
);
```

#### 3.4 Migration en Lot (si nÃ©cessaire)
```javascript
// Pour migrer tous les utilisateurs existants
const usersWithoutWebhooks = await WebhookAdmin.findUsersWithoutWebhooks();
if (usersWithoutWebhooks.success) {
    await WebhookAdmin.batchAssignDefaultWebhooks(
        usersWithoutWebhooks.usersWithoutWebhooks,
        'Migration automatique'
    );
}
```

### Phase 4 : Tests et Validation (30 minutes)

#### 4.1 Test avec Utilisateur Pilote
```javascript
// 1. Se connecter avec un utilisateur de test
// 2. VÃ©rifier les logs dans la console
console.log('Webhook rÃ©cupÃ©rÃ©:', await WebhookManager.getUserWebhook('USER_UID', 'test'));

// 3. Tester l'envoi de donnÃ©es
// 4. VÃ©rifier les logs Firebase pour les mises Ã  jour lastUsed
```

#### 4.2 Validation des Fallbacks
```javascript
// Tester avec un utilisateur sans webhook
const userWithoutWebhook = 'FAKE_USER_ID';
const endpoint = await WebhookManager.getUserWebhook(userWithoutWebhook, 'test');
console.log('Fallback endpoint:', endpoint);
```

#### 4.3 Monitoring des Erreurs
```javascript
// VÃ©rifier les logs en temps rÃ©el
firebase.firestore().collection('userWebhooks').onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
        if (change.type === 'modified') {
            console.log('Webhook mis Ã  jour:', change.doc.id, change.doc.data());
        }
    });
});
```

## ğŸ“Š FonctionnalitÃ©s ImplÃ©mentÃ©es

### âœ… WebhookManager
- **RÃ©cupÃ©ration dynamique** des webhooks par utilisateur et mode
- **Cache intelligent** avec expiration (5 minutes)
- **Validation des URLs** (HTTPS obligatoire)
- **Fallback automatique** vers endpoints par dÃ©faut
- **Mise Ã  jour des statistiques** d'utilisation

### âœ… SÃ©curitÃ© Firestore
- **AccÃ¨s utilisateur limitÃ©** Ã  son propre webhook uniquement
- **Validation des donnÃ©es** cÃ´tÃ© serveur
- **Champs contrÃ´lÃ©s** pour modification
- **HTTPS obligatoire** pour les webhooks

### âœ… Administration
- **Assignation individuelle** ou en lot
- **Gestion des statuts** actif/inactif
- **Statistiques d'utilisation** et logs
- **Export/Import** des configurations
- **Validation** des URLs avant assignment

### âœ… CompatibilitÃ©
- **Migration transparente** depuis endpoints fixes
- **Fallback robuste** en cas d'erreur
- **Pas d'impact utilisateur** - expÃ©rience identique
- **Performance optimisÃ©e** avec cache

## ğŸ” Surveillance et Maintenance

### MÃ©triques ClÃ©s
```javascript
// Obtenir les statistiques du cache
const cacheStats = WebhookManager.getCacheStats();
console.log('Cache stats:', cacheStats);

// Nettoyer le cache expirÃ©
const cleaned = WebhookManager.cleanupExpiredCache();
console.log('EntrÃ©es nettoyÃ©es:', cleaned);
```

### Alertes RecommandÃ©es
- **Webhook inactif** dÃ©tectÃ©
- **Erreur de rÃ©cupÃ©ration** webhook
- **Utilisation anormale** (trop de requÃªtes)
- **URLs invalides** assignÃ©es

### Maintenance RÃ©guliÃ¨re
```javascript
// Nettoyage hebdomadaire du cache
setInterval(() => {
    WebhookManager.cleanupExpiredCache();
}, 7 * 24 * 60 * 60 * 1000);

// Export mensuel des webhooks
const exportData = await WebhookAdmin.exportWebhooks();
```

## ğŸ› ï¸ DÃ©pannage

### ProblÃ¨mes Courants

#### 1. Webhook non trouvÃ©
```javascript
// VÃ©rifier la configuration Firestore
const doc = await firebase.firestore().collection('userWebhooks').doc('USER_ID').get();
if (!doc.exists) {
    console.log('Aucun webhook configurÃ© pour cet utilisateur');
}
```

#### 2. Erreur de permission
```
// VÃ©rifier les rÃ¨gles Firestore
// Firestore Database > RÃ¨gles > Tester avec le simulateur
```

#### 3. Performance dÃ©gradÃ©e
```javascript
// VÃ©rifier le cache
const stats = WebhookManager.getCacheStats();
if (stats.expiredEntries > stats.validEntries) {
    WebhookManager.cleanupExpiredCache();
}
```

### Logs de DÃ©bogage
```javascript
// Activer les logs dÃ©taillÃ©s
localStorage.setItem('webhook-debug', 'true');

// Dans WebhookManager, vÃ©rifier les logs console
console.log('WebhookManager: Debug mode enabled');
```

## ğŸ“‹ Checklist de DÃ©ploiement

### Avant le DÃ©ploiement
- [ ] Firebase project configurÃ©
- [ ] Firestore activÃ©
- [ ] Code testÃ© en dÃ©veloppement
- [ ] RÃ¨gles de sÃ©curitÃ© validÃ©es
- [ ] Utilisateurs identifiÃ©s

### Pendant le DÃ©ploiement
- [ ] RÃ¨gles Firestore dÃ©ployÃ©es
- [ ] Code mis en production
- [ ] Script d'admin chargÃ©
- [ ] Webhooks assignÃ©s aux utilisateurs pilotes
- [ ] Tests fonctionnels validÃ©s

### AprÃ¨s le DÃ©ploiement
- [ ] Migration complÃ¨te des utilisateurs
- [ ] Monitoring activÃ©
- [ ] Documentation utilisateur mise Ã  jour
- [ ] Formation administrateur terminÃ©e
- [ ] Plan de rollback dÃ©fini

## ğŸ”„ Plan de Rollback

En cas de problÃ¨me, revenir au systÃ¨me prÃ©cÃ©dent :

### 1. DÃ©sactiver temporairement le WebhookManager
```javascript
// Dans config.js, remettre les endpoints fixes
ENDPOINTS: {
    normal: 'https://n8n.srv1104707.hstgr.cloud/webhook/DictaMedNormalMode',
    test: 'https://n8n.srv1104707.hstgr.cloud/webhook/DictaMed',
    dmi: 'https://n8n.srv1104707.hstgr.cloud/webhook/DictaMed'
}
```

### 2. Sauvegarder les donnÃ©es Firestore
```javascript
// Export des webhooks avant rollback
const backup = await WebhookAdmin.exportWebhooks();
```

### 3. RedÃ©ployer la version prÃ©cÃ©dente
```bash
git revert HEAD  # ou git checkout previous-version
firebase deploy
```

## ğŸ“ Support

### Contacts
- **DÃ©veloppeur**: [Contact technique]
- **Administrateur Firebase**: [Contact admin]
- **Support n8n**: [Contact n8n]

### Ressources
- **Documentation Firebase**: https://firebase.google.com/docs
- **Firestore Rules**: https://firebase.google.com/docs/firestore/security
- **Logs Firebase**: Console Firebase > Logs

### ProcÃ©dure d'Escalade
1. **Niveau 1**: VÃ©rifier logs console et Firebase
2. **Niveau 2**: Tester avec utilisateur de test
3. **Niveau 3**: Rollback temporaire si nÃ©cessaire
4. **Niveau 4**: Contacter support technique

---

**ğŸ“… Version**: 1.0.0  
**ğŸ‘¨â€ğŸ’¼ DerniÃ¨re mise Ã  jour**: 2025-12-10  
**ğŸ¯ Statut**: PrÃªt pour dÃ©ploiement