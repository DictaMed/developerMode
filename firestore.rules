rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== FONCTIONS UTILITAIRES =====
    // Vérification si l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Vérification si l'utilisateur est l'admin
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.email in ['akio963@gmail.com'];
    }
    
    // Vérification si l'utilisateur accède à ses propres données
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Vérification du niveau de vérification email
    function isEmailVerified() {
      return isAuthenticated() && request.auth.token.email_verified == true;
    }
    
    // Validation des données d'entrée
    function isValidString(value, minLength, maxLength) {
      return value is string && 
             value.size() >= minLength && 
             value.size() <= maxLength;
    }
    
    // Validation d'email
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    // Validation des timestamps
    function isValidTimestamp(ts) {
      return ts is timestamp;
    }
    
    // Vérification de la provenance des données (appareil reconnu)
    function isTrustedDevice() {
      return isAuthenticated() && 
             request.resource.data.deviceFingerprint != null &&
             request.resource.data.deviceFingerprint.size() > 10;
    }
    
    // ===== COLLECTIONS UTILISATEURS =====

    // Collection "users" - Profils utilisateurs (principale)
    match /users/{userId} {
      // Lecture: propriétaire ou admin
      allow read: if isOwner(userId) || isAdmin();

      // Création: utilisateur authentifié créant son propre profil
      allow create: if isOwner(userId) && isAuthenticated();

      // Mise à jour: propriétaire ou admin
      allow update: if (isOwner(userId) || isAdmin()) && isAuthenticated();

      // Suppression: uniquement par l'admin
      allow delete: if isAdmin();

      // Sous-collections pour chaque utilisateur
      match /twoFactorConfig/{document=**} {
        // Lecture/Écriture: propriétaire uniquement
        allow read, write: if isOwner(userId) && isAuthenticated();
      }

      match /devices/{deviceId} {
        // Lecture/Écriture: propriétaire uniquement
        allow read, write: if isOwner(userId) && isAuthenticated();
      }
    }

    // Profils utilisateurs avec validation stricte (maintenu pour compatibilité)
    match /userProfiles/{userId} {
      // Lecture: admin ou propriétaire du profil
      allow read: if isOwner(userId) || isAdmin();

      // Création: utilisateur authentifié créant son propre profil
      allow create: if isOwner(userId) &&
                    validateUserProfile(resource.data) &&
                    isEmailVerified();

      // Mise à jour: propriétaire ou admin avec validation
      allow update: if (isOwner(userId) || isAdmin()) &&
                    validateUserProfileUpdate(resource.data, request.resource.data) &&
                    isEmailVerified();

      // Suppression: uniquement par l'admin
      allow delete: if isAdmin();
    }

    // ===== COLLECTIONS ADMINISTRATEUR =====
    
    // Webhooks administrateur - accès amélioré
    match /adminWebhooks/{document=**} {
      // Accès pour l'admin (moins restrictif)
      allow read, write: if isAdmin() && isAuthenticated();
    }
    
    // Système - gestion globale améliorée
    match /system/{documentId} {
      // Accès pour l'admin (moins restrictif)
      allow read, write: if isAdmin() && isAuthenticated();
    }
    
    // Logs d'utilisation avec permissions améliorées
    match /webhookLogs/{logId} {
      // Lecture: admin ou propriétaire
      allow read: if isAdmin() || (isAuthenticated() && request.auth.uid == logId);
      
      // Écriture: admin ou via Cloud Functions
      allow write: if isAdmin() || false; // Empêche l'écriture directe depuis le client
    }
    
    // ===== COLLECTIONS DE DIAGNOSTIC ET TEST =====
    
    // Collection de diagnostic - accès contrôlé
    match /_diagnostic/{documentId} {
      // Lecture: utilisateurs authentifiés avec raison valide
      allow read: if isAuthenticated() && 
                    request.resource.data.reason in ['user_request', 'admin_request', 'security_audit'];
      
      // Écriture: utilisateurs authentifiés pour diagnostic
      allow write: if isAuthenticated() && 
                    validateDiagnosticData(request.resource.data) &&
                    request.resource.data.timestamp == request.time;
    }
    
    // Tests de permissions - environnement de développement
    match /_permission_test/{documentId} {
      // Accès en lecture/écriture pour les tests authentifiés
      allow read, write: if isAuthenticated() && 
                          request.auth.token.email_verified == true;
    }
    
    // ===== COLLECTION STATISTIQUES UTILISATEUR =====

    // Statistiques utilisateur (userStats)
    match /userStats/{userId} {
      // Lecture: propriétaire ou admin peut voir ses propres stats
      allow read: if isOwner(userId) || isAdmin();

      // Création: utilisateur authentifié créant ses propres stats
      allow create: if isOwner(userId) && isAuthenticated() &&
                    validateUserStats(request.resource.data);

      // Mise à jour: propriétaire peut mettre à jour ses stats
      allow update: if isOwner(userId) && isAuthenticated() &&
                    validateUserStatsUpdate(request.resource.data);

      // Suppression: uniquement admin
      allow delete: if isAdmin();
    }

    // Validation des données de statistiques utilisateur
    function validateUserStats(data) {
      return data.keys().hasAny(['totalSends', 'normalModeSends', 'dmiModeSends', 'testModeSends']) &&
             (data.totalSends == null || data.totalSends is number) &&
             (data.normalModeSends == null || data.normalModeSends is number) &&
             (data.dmiModeSends == null || data.dmiModeSends is number) &&
             (data.testModeSends == null || data.testModeSends is number) &&
             (data.totalPhotos == null || data.totalPhotos is number) &&
             (data.totalAudioRecordings == null || data.totalAudioRecordings is number) &&
             (data.totalAudioDuration == null || data.totalAudioDuration is number) &&
             (data.totalSessions == null || data.totalSessions is number);
    }

    // Validation de mise à jour des statistiques
    function validateUserStatsUpdate(data) {
      // Les statistiques ne peuvent qu'augmenter (pas de réduction frauduleuse)
      return (data.totalSends == null || data.totalSends is number) &&
             (data.normalModeSends == null || data.normalModeSends is number) &&
             (data.dmiModeSends == null || data.dmiModeSends is number) &&
             (data.testModeSends == null || data.testModeSends is number) &&
             (data.totalPhotos == null || data.totalPhotos is number) &&
             (data.totalAudioRecordings == null || data.totalAudioRecordings is number) &&
             (data.totalAudioDuration == null || data.totalAudioDuration is number) &&
             (data.totalSessions == null || data.totalSessions is number);
    }

    // ===== COLLECTIONS DE SÉCURITÉ =====

    // Sessions utilisateur avec sécurité renforcée
    match /userSessions/{sessionId} {
      // Lecture: uniquement le propriétaire de la session
      allow read: if isAuthenticated() && 
                    request.auth.uid in resource.data.participants;
      
      // Création: utilisateur authentifié créant une session
      allow create: if isAuthenticated() && 
                    request.auth.uid in request.resource.data.participants &&
                    validateUserSession(request.resource.data) &&
                    isEmailVerified();
      
      // Mise à jour: propriétaire avec validation stricte
      allow update: if isAuthenticated() && 
                    request.auth.uid in resource.data.participants &&
                    validateUserSessionUpdate(resource.data, request.resource.data);
      
      // Suppression: propriétaire ou admin
      allow delete: if isAuthenticated() && 
                    (request.auth.uid in resource.data.participants || isAdmin());
    }
    
    // Audit logs - permissions améliorées
    match /auditLogs/{logId} {
      // Lecture: admin ou utilisateur concerné
      allow read: if isAdmin() || (isAuthenticated() && request.auth.uid == logId);
      
      // Écriture: via Cloud Functions uniquement
      allow write: if false; // Empêche l'écriture directe depuis le client
    }
    
    // Appareils enregistrés par l'utilisateur
    match /userDevices/{userId}/devices/{deviceId} {
      // Lecture: propriétaire uniquement
      allow read: if isOwner(userId) && isEmailVerified();
      
      // Création/Modification: propriétaire avec validation
      allow create, update: if isOwner(userId) && 
                            validateUserDevice(request.resource.data) &&
                            isEmailVerified();
      
      // Suppression: propriétaire
      allow delete: if isOwner(userId);
    }
    
    // ===== FONCTIONS DE VALIDATION =====
    
    // Validation des données de profil utilisateur
    function validateUserProfile(data) {
      return data.keys().hasAll(['userId', 'email', 'createdAt', 'lastUpdated']) &&
             data.userId == request.auth.uid &&
             data.email == request.auth.token.email &&
             isValidString(data.displayName, 2, 50) &&
             isValidEmail(data.email) &&
             isValidTimestamp(data.createdAt) &&
             isValidTimestamp(data.lastUpdated) &&
             (data.profession in ['medecin', 'infirmier', 'secretaire', 'administrateur'] || 
              data.profession == null);
    }
    
    // Validation de mise à jour de profil
    function validateUserProfileUpdate(oldData, newData) {
      return newData.userId == oldData.userId &&
             newData.email == oldData.email &&
             newData.createdAt == oldData.createdAt &&
             (newData.displayName == oldData.displayName || 
              isValidString(newData.displayName, 2, 50)) &&
             (newData.profession == oldData.profession ||
              newData.profession in ['medecin', 'infirmier', 'secretaire', 'administrateur'] ||
              newData.profession == null) &&
             newData.lastUpdated == request.time;
    }
    
    // Validation des données de diagnostic
    function validateDiagnosticData(data) {
      return data.keys().hasAll(['timestamp', 'reason', 'userId']) &&
             data.userId == request.auth.uid &&
             data.reason in ['user_request', 'admin_request', 'security_audit'] &&
             isValidTimestamp(data.timestamp);
    }
    
    // Validation des données de session utilisateur
    function validateUserSession(data) {
      return data.keys().hasAll(['participants', 'createdAt', 'expiresAt']) &&
             request.auth.uid in data.participants &&
             data.participants.size() <= 5 && // Limite du nombre de participants
             isValidTimestamp(data.createdAt) &&
             isValidTimestamp(data.expiresAt) &&
             data.expiresAt > data.createdAt;
    }
    
    // Validation de mise à jour de session
    function validateUserSessionUpdate(oldData, newData) {
      return newData.participants == oldData.participants &&
             newData.createdAt == oldData.createdAt &&
             (newData.expiresAt == oldData.expiresAt || 
              (isValidTimestamp(newData.expiresAt) && newData.expiresAt > oldData.createdAt));
    }
    
    // Validation des données d'appareil utilisateur
    function validateUserDevice(data) {
      return data.keys().hasAll(['deviceName', 'fingerprint', 'registeredAt', 'isTrusted']) &&
             isValidString(data.deviceName, 1, 100) &&
             isValidString(data.fingerprint, 10, 500) &&
             data.isTrusted is bool &&
             isValidTimestamp(data.registeredAt);
    }
    
    // ===== RÈGLES SPÉCIALES DE SÉCURITÉ =====
    
    // Permettre l'accès par défaut pour les autres collections
    match /{document=**} {
      // Accès de base pour les collections non définies
      allow read, write: if isAuthenticated();
    }
    
    // Fonction de limitation de taux désactivée temporairement
    function isRateLimited() {
      // Désactivé temporairement pour résoudre les problèmes de permissions
      return false;
    }
  }
}