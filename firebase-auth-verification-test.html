<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Test Complet Firebase Auth - DictaMed</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-loading { background: #17a2b8; animation: pulse 1s infinite; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Complet Firebase Authentication - DictaMed</h1>
        <p>Ce test v√©rifie que tous les bugs d'authentification ont √©t√© corrig√©s.</p>
        
        <!-- Status Global -->
        <div class="test-section">
            <h2>üìä Status Global</h2>
            <div id="globalStatus">Initialisation...</div>
            <button onclick="runFullTest()">üöÄ Lancer tous les tests</button>
            <button onclick="clearResults()">üóëÔ∏è Effacer les r√©sultats</button>
        </div>
        
        <div class="test-grid">
            <!-- Test 1: Firebase SDK -->
            <div class="test-section">
                <h3><span class="status-indicator status-loading" id="sdkStatus"></span>üì¶ Firebase SDK</h3>
                <button onclick="testFirebaseSDK()">Test SDK</button>
                <div id="sdkResult"></div>
            </div>
            
            <!-- Test 2: Firebase Auth Manager -->
            <div class="test-section">
                <h3><span class="status-indicator status-loading" id="authManagerStatus"></span>üîê Auth Manager</h3>
                <button onclick="testAuthManager()">Test Manager</button>
                <div id="authManagerResult"></div>
            </div>
            
            <!-- Test 3: Configuration Firebase -->
            <div class="test-section">
                <h3><span class="status-indicator status-loading" id="configStatus"></span>‚öôÔ∏è Configuration</h3>
                <button onclick="testFirebaseConfig()">Test Config</button>
                <div id="configResult"></div>
            </div>
            
            <!-- Test 4: Sign Up -->
            <div class="test-section">
                <h3><span class="status-indicator status-loading" id="signupStatus"></span>‚ú® Sign Up</h3>
                <input type="email" id="testEmail" placeholder="Email de test" value="test@example.com">
                <input type="password" id="testPassword" placeholder="Mot de passe" value="testpassword123">
                <button onclick="testSignUp()">Test Inscription</button>
                <div id="signupResult"></div>
            </div>
            
            <!-- Test 5: Sign In -->
            <div class="test-section">
                <h3><span class="status-indicator status-loading" id="signinStatus"></span>üîë Sign In</h3>
                <button onclick="testSignIn()">Test Connexion</button>
                <div id="signinResult"></div>
            </div>
            
            <!-- Test 6: Google Auth -->
            <div class="test-section">
                <h3><span class="status-indicator status-loading" id="googleStatus"></span>üîç Google Auth</h3>
                <button onclick="testGoogleSignIn()">Test Google</button>
                <div id="googleResult"></div>
            </div>
            
            <!-- Test 7: Password Reset -->
            <div class="test-section">
                <h3><span class="status-indicator status-loading" id="resetStatus"></span>üìß Password Reset</h3>
                <input type="email" id="resetEmail" placeholder="Email pour reset" value="test@example.com">
                <button onclick="testPasswordReset()">Test Reset</button>
                <div id="resetResult"></div>
            </div>
            
            <!-- Test 8: Sign Out -->
            <div class="test-section">
                <h3><span class="status-indicator status-loading" id="signoutStatus"></span>üö™ Sign Out</h3>
                <button onclick="testSignOut()">Test D√©connexion</button>
                <div id="signoutResult"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v10+ Modulaire -->
    <script type="module">
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC9XYvHxbp3VW0PCW0W7xfoWuiMxsjoUZE",
            authDomain: "dictamed2025.firebaseapp.com",
            projectId: "dictamed2025",
            storageBucket: "dictamed2025.firebasestorage.app",
            messagingSenderId: "242034923776",
            appId: "1:242034923776:web:bd315e890c715b1d263be5",
            measurementId: "G-1B8DZ4B73R"
        };
        
        // Charger Firebase SDK modulaire
        const loadFirebase = async () => {
            try {
                console.log('üîÑ Chargement Firebase pour tests...');
                
                // Importer les modules Firebase
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { 
                    getAuth, 
                    onAuthStateChanged,
                    signInWithEmailAndPassword,
                    createUserWithEmailAndPassword,
                    signOut,
                    sendPasswordResetEmail,
                    GoogleAuthProvider,
                    signInWithPopup
                } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                
                // Initialiser Firebase
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                
                // Rendre disponible globalement
                window.firebase = {
                    app: app,
                    auth: auth,
                    onAuthStateChanged: onAuthStateChanged,
                    signInWithEmailAndPassword: signInWithEmailAndPassword,
                    createUserWithEmailAndPassword: createUserWithEmailAndPassword,
                    signOut: signOut,
                    sendPasswordResetEmail: sendPasswordResetEmail,
                    GoogleAuthProvider: GoogleAuthProvider,
                    signInWithPopup: signInWithPopup
                };
                
                console.log('‚úÖ Firebase SDK modulaire charg√© pour tests');
                window.dispatchEvent(new Event('firebaseReady'));
                
                return window.firebase;
                
            } catch (error) {
                console.error('‚ùå Erreur chargement Firebase:', error);
                throw error;
            }
        };
        
        // Charger Firebase imm√©diatement
        window.initFirebase = loadFirebase;
        loadFirebase().catch(error => {
            console.error('‚ùå √âchec chargement Firebase:', error);
        });
    </script>

    <!-- Firebase Auth Manager (Version Corrig√©e) -->
    <script src="js/components/firebase-auth-manager.js"></script>

    <!-- Tests -->
    <script>
        const testResults = {};
        
        function setStatus(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = `status-indicator status-${status}`;
        }
        
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${content}</div>`;
        }
        
        function logTest(testName, result) {
            testResults[testName] = result;
            updateGlobalStatus();
        }
        
        function updateGlobalStatus() {
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r.success).length;
            const failed = Object.values(testResults).filter(r => r.success === false).length;
            
            const statusDiv = document.getElementById('globalStatus');
            statusDiv.innerHTML = `
                <p><strong>Tests r√©ussis:</strong> ${passed}/${total}</p>
                <p><strong>Tests √©chou√©s:</strong> ${failed}/${total}</p>
                <p><strong>Status global:</strong> ${failed === 0 ? '‚úÖ TOUS LES TESTS PASSENT' : '‚ùå CERTAINS TESTS √âCHOUENT'}</p>
            `;
        }
        
        async function testFirebaseSDK() {
            setStatus('sdkStatus', 'loading');
            
            try {
                await new Promise((resolve) => {
                    if (window.firebase && window.firebase.auth) {
                        resolve();
                    } else {
                        const handleFirebaseReady = () => {
                            window.removeEventListener('firebaseReady', handleFirebaseReady);
                            resolve();
                        };
                        window.addEventListener('firebaseReady', handleFirebaseReady);
                        setTimeout(resolve, 3000);
                    }
                });
                
                const checks = {
                    'Firebase SDK disponible': typeof window.firebase !== 'undefined',
                    'Firebase Auth disponible': window.firebase && window.firebase.auth,
                    'M√©thodes d\'auth disponibles': window.firebase && typeof window.firebase.signInWithEmailAndPassword === 'function'
                };
                
                const allPassed = Object.values(checks).every(v => v);
                
                showResult('sdkResult', 
                    Object.entries(checks).map(([check, passed]) => 
                        `${passed ? '‚úÖ' : '‚ùå'} ${check}: ${passed ? 'OK' : '√âCHEC'}`
                    ).join('\n'),
                    allPassed ? 'success' : 'error'
                );
                
                setStatus('sdkStatus', allPassed ? 'success' : 'error');
                logTest('Firebase SDK', { success: allPassed, details: checks });
                
            } catch (error) {
                showResult('sdkResult', `‚ùå Erreur: ${error.message}`, 'error');
                setStatus('sdkStatus', 'error');
                logTest('Firebase SDK', { success: false, error: error.message });
            }
        }
        
        async function testAuthManager() {
            setStatus('authManagerStatus', 'loading');
            
            try {
                // Attendre que Firebase Auth Manager soit initialis√©
                await new Promise((resolve) => {
                    if (window.FirebaseAuthManager) {
                        resolve();
                    } else {
                        setTimeout(resolve, 2000);
                    }
                });
                
                const checks = {
                    'FirebaseAuthManager disponible': typeof window.FirebaseAuthManager !== 'undefined',
                    'M√©thode init disponible': window.FirebaseAuthManager && typeof window.FirebaseAuthManager.init === 'function',
                    'M√©thodes auth disponibles': window.FirebaseAuthManager && 
                        typeof window.FirebaseAuthManager.signIn === 'function' &&
                        typeof window.FirebaseAuthManager.signUp === 'function'
                };
                
                const allPassed = Object.values(checks).every(v => v);
                
                showResult('authManagerResult', 
                    Object.entries(checks).map(([check, passed]) => 
                        `${passed ? '‚úÖ' : '‚ùå'} ${check}: ${passed ? 'OK' : '√âCHEC'}`
                    ).join('\n'),
                    allPassed ? 'success' : 'error'
                );
                
                setStatus('authManagerStatus', allPassed ? 'success' : 'error');
                logTest('Auth Manager', { success: allPassed, details: checks });
                
            } catch (error) {
                showResult('authManagerResult', `‚ùå Erreur: ${error.message}`, 'error');
                setStatus('authManagerStatus', 'error');
                logTest('Auth Manager', { success: false, error: error.message });
            }
        }
        
        async function testFirebaseConfig() {
            setStatus('configStatus', 'loading');
            
            try {
                const config = await window.FirebaseAuthManager.checkAuthConfiguration();
                
                const checks = {
                    'Configur√©e': config.isConfigured,
                    'Project ID': !!config.projectId,
                    'Auth Domain': !!config.authDomain,
                    'Providers OK': config.providers && config.providers.emailPassword
                };
                
                const allPassed = Object.values(checks).every(v => v);
                
                showResult('configResult', 
                    `üìä Configuration Firebase:\n` +
                    Object.entries(config).map(([key, value]) => `‚Ä¢ ${key}: ${value}`).join('\n') +
                    `\n\nChecks:\n` +
                    Object.entries(checks).map(([check, passed]) => 
                        `${passed ? '‚úÖ' : '‚ùå'} ${check}: ${passed ? 'OK' : '√âCHEC'}`
                    ).join('\n'),
                    allPassed ? 'success' : 'warning'
                );
                
                setStatus('configStatus', allPassed ? 'success' : 'warning');
                logTest('Firebase Config', { success: allPassed, config, details: checks });
                
            } catch (error) {
                showResult('configResult', `‚ùå Erreur: ${error.message}`, 'error');
                setStatus('configStatus', 'error');
                logTest('Firebase Config', { success: false, error: error.message });
            }
        }
        
        async function testSignUp() {
            setStatus('signupStatus', 'loading');
            
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            try {
                const result = await window.FirebaseAuthManager.signUp(email, password);
                
                if (result.success) {
                    showResult('signupResult', 
                        `‚úÖ Inscription r√©ussie!\n` +
                        `Utilisateur: ${result.user.email}\n` +
                        `UID: ${result.user.uid}\n` +
                        `Email envoy√©: ${result.emailSent ? 'Oui' : 'Non'}`,
                        'success'
                    );
                    setStatus('signupStatus', 'success');
                    logTest('Sign Up', { success: true, user: result.user });
                } else {
                    showResult('signupResult', 
                        `‚ùå Erreur d'inscription:\n` +
                        `Code: ${result.code}\n` +
                        `Message: ${result.error}`,
                        'error'
                    );
                    setStatus('signupStatus', 'error');
                    logTest('Sign Up', { success: false, error: result.error, code: result.code });
                }
                
            } catch (error) {
                showResult('signupResult', `‚ùå Erreur: ${error.message}`, 'error');
                setStatus('signupStatus', 'error');
                logTest('Sign Up', { success: false, error: error.message });
            }
        }
        
        async function testSignIn() {
            setStatus('signinStatus', 'loading');
            
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            try {
                const result = await window.FirebaseAuthManager.signIn(email, password);
                
                if (result.success) {
                    showResult('signinResult', 
                        `‚úÖ Connexion r√©ussie!\n` +
                        `Utilisateur: ${result.user.email}\n` +
                        `UID: ${result.user.uid}`,
                        'success'
                    );
                    setStatus('signinStatus', 'success');
                    logTest('Sign In', { success: true, user: result.user });
                } else {
                    showResult('signinResult', 
                        `‚ùå Erreur de connexion:\n` +
                        `Code: ${result.code}\n` +
                        `Message: ${result.error}`,
                        'error'
                    );
                    setStatus('signinStatus', 'error');
                    logTest('Sign In', { success: false, error: result.error, code: result.code });
                }
                
            } catch (error) {
                showResult('signinResult', `‚ùå Erreur: ${error.message}`, 'error');
                setStatus('signinStatus', 'error');
                logTest('Sign In', { success: false, error: error.message });
            }
        }
        
        async function testGoogleSignIn() {
            setStatus('googleStatus', 'loading');
            
            try {
                const result = await window.FirebaseAuthManager.signInWithGoogle();
                
                if (result.success) {
                    showResult('googleResult', 
                        `‚úÖ Connexion Google r√©ussie!\n` +
                        `Utilisateur: ${result.user.email}\n` +
                        `Provider: ${result.user.providerId}`,
                        'success'
                    );
                    setStatus('googleStatus', 'success');
                    logTest('Google Sign In', { success: true, user: result.user });
                } else {
                    showResult('googleResult', 
                        `‚ùå Erreur Google Auth:\n` +
                        `Code: ${result.code}\n` +
                        `Message: ${result.error}`,
                        'error'
                    );
                    setStatus('googleStatus', 'error');
                    logTest('Google Sign In', { success: false, error: result.error, code: result.code });
                }
                
            } catch (error) {
                showResult('googleResult', `‚ùå Erreur: ${error.message}`, 'error');
                setStatus('googleStatus', 'error');
                logTest('Google Sign In', { success: false, error: error.message });
            }
        }
        
        async function testPasswordReset() {
            setStatus('resetStatus', 'loading');
            
            const email = document.getElementById('resetEmail').value;
            
            try {
                const result = await window.FirebaseAuthManager.sendPasswordResetEmail(email);
                
                if (result.success) {
                    showResult('resetResult', 
                        `‚úÖ Email de reset envoy√© avec succ√®s!\n` +
                        `V√©rifiez votre bo√Æte email: ${email}`,
                        'success'
                    );
                    setStatus('resetStatus', 'success');
                    logTest('Password Reset', { success: true, email });
                } else {
                    showResult('resetResult', 
                        `‚ùå Erreur lors du reset:\n` +
                        `Code: ${result.code}\n` +
                        `Message: ${result.error}`,
                        'error'
                    );
                    setStatus('resetStatus', 'error');
                    logTest('Password Reset', { success: false, error: result.error, code: result.code });
                }
                
            } catch (error) {
                showResult('resetResult', `‚ùå Erreur: ${error.message}`, 'error');
                setStatus('resetStatus', 'error');
                logTest('Password Reset', { success: false, error: error.message });
            }
        }
        
        async function testSignOut() {
            setStatus('signoutStatus', 'loading');
            
            try {
                const result = await window.FirebaseAuthManager.signOut();
                
                if (result.success) {
                    showResult('signoutResult', 
                        `‚úÖ D√©connexion r√©ussie!`,
                        'success'
                    );
                    setStatus('signoutStatus', 'success');
                    logTest('Sign Out', { success: true });
                } else {
                    showResult('signoutResult', 
                        `‚ùå Erreur de d√©connexion:\n` +
                        `Message: ${result.error}`,
                        'error'
                    );
                    setStatus('signoutStatus', 'error');
                    logTest('Sign Out', { success: false, error: result.error });
                }
                
            } catch (error) {
                showResult('signoutResult', `‚ùå Erreur: ${error.message}`, 'error');
                setStatus('signoutStatus', 'error');
                logTest('Sign Out', { success: false, error: error.message });
            }
        }
        
        async function runFullTest() {
            console.log('üöÄ Lancement des tests complets...');
            
            // R√©initialiser les r√©sultats
            Object.keys(testResults).forEach(key => delete testResults[key]);
            updateGlobalStatus();
            
            // Attendre que Firebase soit pr√™t
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Ex√©cuter tous les tests
            await testFirebaseSDK();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAuthManager();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testFirebaseConfig();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Tests d'authentification (optionnels)
            console.log('üí° Tests d\'authentification pr√™ts. Cliquez sur les boutons individuels pour les tester.');
        }
        
        function clearResults() {
            Object.keys(testResults).forEach(key => delete testResults[key]);
            updateGlobalStatus();
            
            const resultDivs = ['sdkResult', 'authManagerResult', 'configResult', 'signupResult', 
                              'signinResult', 'googleResult', 'resetResult', 'signoutResult'];
            resultDivs.forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
            
            const statusIndicators = ['sdkStatus', 'authManagerStatus', 'configStatus', 'signupStatus',
                                    'signinStatus', 'googleStatus', 'resetStatus', 'signoutStatus'];
            statusIndicators.forEach(id => {
                setStatus(id, 'loading');
            });
        }
        
        // Initialisation
        window.addEventListener('firebaseReady', () => {
            console.log('üì¢ Firebase pr√™t pour les tests');
            document.getElementById('globalStatus').innerHTML = '‚úÖ Firebase charg√©, pr√™t pour les tests';
        });
        
        // Auto-lancer les tests de base apr√®s 3 secondes
        setTimeout(() => {
            runFullTest();
        }, 3000);
    </script>
</body>
</html>