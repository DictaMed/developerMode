<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Firebase Auth - DictaMed (Version Corrig√©e)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Firebase Authentication - Version Corrig√©e</h1>
        <p>Ce test v√©rifie que l'erreur "Firebase Auth not available" est r√©solue.</p>
        
        <!-- Diagnostic Firebase -->
        <div class="test-section">
            <h2>üìä Diagnostic Firebase SDK</h2>
            <button onclick="runFirebaseDiagnostic()">Lancer le diagnostic</button>
            <div id="firebaseStatus"></div>
        </div>
        
        <!-- Test d'authentification Email/Password -->
        <div class="test-section">
            <h2>üìß Test Email/Password</h2>
            <input type="email" id="testEmail" placeholder="Email de test" value="test@example.com">
            <input type="password" id="testPassword" placeholder="Mot de passe" value="testpassword123">
            <div>
                <button onclick="testSignUp()">Test Inscription</button>
                <button onclick="testSignIn()">Test Connexion</button>
                <button onclick="testSignOut()">Test D√©connexion</button>
            </div>
            <div id="emailAuthResult"></div>
        </div>
        
        <!-- Test Google Auth -->
        <div class="test-section">
            <h2>üîç Test Google Auth</h2>
            <button onclick="testGoogleSignIn()">Test Connexion Google</button>
            <div id="googleAuthResult"></div>
        </div>
        
        <!-- Reset Password -->
        <div class="test-section">
            <h2>üîë Test Reset Password</h2>
            <input type="email" id="resetEmail" placeholder="Email pour reset" value="test@example.com">
            <button onclick="testPasswordReset()">Envoyer Reset Email</button>
            <div id="passwordResetResult"></div>
        </div>
        
        <!-- √âtat actuel -->
        <div class="test-section">
            <h2>üë§ √âtat d'authentification</h2>
            <button onclick="checkCurrentUser()">V√©rifier utilisateur actuel</button>
            <div id="currentUserStatus"></div>
        </div>
    </div>

    <!-- Firebase SDK v10+ Modulaire -->
    <script type="module">
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC9XYvHxbp3VW0PCW0W7xfoWuiMxsjoUZE",
            authDomain: "dictamed2025.firebaseapp.com",
            projectId: "dictamed2025",
            storageBucket: "dictamed2025.firebasestorage.app",
            messagingSenderId: "242034923776",
            appId: "1:242034923776:web:bd315e890c715b1d263be5",
            measurementId: "G-1B8DZ4B73R"
        };
        
        // Charger Firebase SDK modulaire
        const loadFirebase = async () => {
            try {
                // Importer les modules Firebase
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { 
                    getAuth, 
                    onAuthStateChanged,
                    signInWithEmailAndPassword,
                    createUserWithEmailAndPassword,
                    signOut,
                    sendPasswordResetEmail,
                    GoogleAuthProvider,
                    signInWithPopup
                } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                
                // Initialiser Firebase
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                
                // Rendre disponible globalement pour compatibilit√©
                window.firebase = {
                    app: app,
                    auth: auth,
                    // M√©thodes d'authentification
                    onAuthStateChanged: onAuthStateChanged,
                    signInWithEmailAndPassword: signInWithEmailAndPassword,
                    createUserWithEmailAndPassword: createUserWithEmailAndPassword,
                    signOut: signOut,
                    sendPasswordResetEmail: sendPasswordResetEmail,
                    GoogleAuthProvider: GoogleAuthProvider,
                    signInWithPopup: signInWithPopup
                };
                
                console.log('‚úÖ Firebase SDK modulaire initialis√© avec succ√®s');
                console.log('üìä Configur√© pour:', firebaseConfig.projectId);
                
                // Dispatcher un √©v√©nement pour informer les autres scripts
                window.dispatchEvent(new Event('firebaseReady'));
                
                return window.firebase;
                
            } catch (error) {
                console.error('‚ùå Erreur Firebase SDK modulaire:', error);
                throw error;
            }
        };
        
        // Charger Firebase imm√©diatement
        window.initFirebase = loadFirebase;
        
        // Charger automatiquement
        loadFirebase().catch(error => {
            console.error('‚ùå √âchec du chargement Firebase:', error);
        });
    </script>

    <!-- Test Functions -->
    <script>
        // Fonction de diagnostic
        async function runFirebaseDiagnostic() {
            const statusDiv = document.getElementById('firebaseStatus');
            statusDiv.innerHTML = '<p class="warning">Diagnostic en cours...</p>';
            
            try {
                // Attendre que Firebase soit pr√™t
                await new Promise((resolve) => {
                    if (window.firebase && window.firebase.auth) {
                        resolve();
                    } else {
                        const handleFirebaseReady = () => {
                            window.removeEventListener('firebaseReady', handleFirebaseReady);
                            resolve();
                        };
                        window.addEventListener('firebaseReady', handleFirebaseReady);
                        setTimeout(resolve, 3000); // Timeout de 3s
                    }
                });
                
                const results = [];
                
                // Test 1: Firebase SDK disponible
                results.push({
                    test: 'Firebase SDK disponible',
                    status: typeof window.firebase !== 'undefined' ? 'success' : 'error',
                    message: typeof window.firebase !== 'undefined' ? 'OK' : 'Non disponible'
                });
                
                // Test 2: Firebase Auth disponible
                results.push({
                    test: 'Firebase Auth disponible',
                    status: window.firebase && window.firebase.auth ? 'success' : 'error',
                    message: window.firebase && window.firebase.auth ? 'OK' : 'Non disponible'
                });
                
                // Test 3: M√©thodes d'authentification
                const authMethods = ['signInWithEmailAndPassword', 'createUserWithEmailAndPassword', 'signOut', 'sendPasswordResetEmail', 'GoogleAuthProvider', 'signInWithPopup'];
                const availableMethods = authMethods.filter(method => typeof window.firebase[method] === 'function');
                
                results.push({
                    test: 'M√©thodes d\'authentification',
                    status: availableMethods.length === authMethods.length ? 'success' : 'warning',
                    message: `${availableMethods.length}/${authMethods.length} m√©thodes disponibles`
                });
                
                // Test 4: Configuration Firebase
                if (window.firebase && window.firebase.app) {
                    const config = window.firebase.app.options;
                    results.push({
                        test: 'Configuration Firebase',
                        status: config.projectId ? 'success' : 'error',
                        message: `Projet: ${config.projectId}`
                    });
                }
                
                // Afficher les r√©sultats
                let html = '<h3>üìä R√©sultats du diagnostic:</h3>';
                results.forEach(result => {
                    const className = result.status === 'success' ? 'success' : 
                                   result.status === 'warning' ? 'warning' : 'error';
                    html += `<p class="${className}">‚úÖ ${result.test}: ${result.message}</p>`;
                });
                
                const allSuccess = results.every(r => r.status === 'success');
                html += `<p class="${allSuccess ? 'success' : 'error'}">${allSuccess ? 'üéâ Firebase est correctement configur√©!' : '‚ö†Ô∏è Des probl√®mes ont √©t√© d√©tect√©s.'}</p>`;
                
                statusDiv.innerHTML = html;
                
            } catch (error) {
                statusDiv.innerHTML = `<p class="error">‚ùå Erreur lors du diagnostic: ${error.message}</p>`;
            }
        }
        
        // Test inscription
        async function testSignUp() {
            const resultDiv = document.getElementById('emailAuthResult');
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            resultDiv.innerHTML = '<p class="warning">Test d\'inscription en cours...</p>';
            
            try {
                const { createUserWithEmailAndPassword } = window.firebase;
                const result = await createUserWithEmailAndPassword(window.firebase.auth, email, password);
                
                resultDiv.innerHTML = `
                    <div class="result success">
                        <p>‚úÖ Inscription r√©ussie!</p>
                        <p>Utilisateur: ${result.user.email}</p>
                        <p>UID: ${result.user.uid}</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <p>‚ùå Erreur d'inscription:</p>
                        <p>Code: ${error.code}</p>
                        <p>Message: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Test connexion
        async function testSignIn() {
            const resultDiv = document.getElementById('emailAuthResult');
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            resultDiv.innerHTML = '<p class="warning">Test de connexion en cours...</p>';
            
            try {
                const { signInWithEmailAndPassword } = window.firebase;
                const result = await signInWithEmailAndPassword(window.firebase.auth, email, password);
                
                resultDiv.innerHTML = `
                    <div class="result success">
                        <p>‚úÖ Connexion r√©ussie!</p>
                        <p>Utilisateur: ${result.user.email}</p>
                        <p>UID: ${result.user.uid}</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <p>‚ùå Erreur de connexion:</p>
                        <p>Code: ${error.code}</p>
                        <p>Message: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Test d√©connexion
        async function testSignOut() {
            const resultDiv = document.getElementById('emailAuthResult');
            
            resultDiv.innerHTML = '<p class="warning">Test de d√©connexion en cours...</p>';
            
            try {
                const { signOut } = window.firebase;
                await signOut(window.firebase.auth);
                
                resultDiv.innerHTML = `
                    <div class="result success">
                        <p>‚úÖ D√©connexion r√©ussie!</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <p>‚ùå Erreur de d√©connexion:</p>
                        <p>Message: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Test Google Auth
        async function testGoogleSignIn() {
            const resultDiv = document.getElementById('googleAuthResult');
            
            resultDiv.innerHTML = '<p class="warning">Test Google Auth en cours...</p>';
            
            try {
                const { GoogleAuthProvider, signInWithPopup } = window.firebase;
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(window.firebase.auth, provider);
                
                resultDiv.innerHTML = `
                    <div class="result success">
                        <p>‚úÖ Connexion Google r√©ussie!</p>
                        <p>Utilisateur: ${result.user.email}</p>
                        <p>Provider: ${result.user.providerId}</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <p>‚ùå Erreur Google Auth:</p>
                        <p>Code: ${error.code}</p>
                        <p>Message: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Test reset password
        async function testPasswordReset() {
            const resultDiv = document.getElementById('passwordResetResult');
            const email = document.getElementById('resetEmail').value;
            
            resultDiv.innerHTML = '<p class="warning">Envoi de l\'email de reset en cours...</p>';
            
            try {
                const { sendPasswordResetEmail } = window.firebase;
                await sendPasswordResetEmail(window.firebase.auth, email);
                
                resultDiv.innerHTML = `
                    <div class="result success">
                        <p>‚úÖ Email de reset envoy√© avec succ√®s!</p>
                        <p>V√©rifiez votre bo√Æte email: ${email}</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <p>‚ùå Erreur lors du reset:</p>
                        <p>Code: ${error.code}</p>
                        <p>Message: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // V√©rifier utilisateur actuel
        function checkCurrentUser() {
            const resultDiv = document.getElementById('currentUserStatus');
            
            try {
                const user = window.firebase.auth.currentUser;
                
                if (user) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <p>‚úÖ Utilisateur connect√©:</p>
                            <p>Email: ${user.email}</p>
                            <p>UID: ${user.uid}</p>
                            <p>Email v√©rifi√©: ${user.emailVerified ? 'Oui' : 'Non'}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result">
                            <p>‚ÑπÔ∏è Aucun utilisateur connect√©</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <p>‚ùå Erreur lors de la v√©rification:</p>
                        <p>Message: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // √âcouter les changements d'√©tat d'authentification
        window.addEventListener('firebaseReady', () => {
            console.log('üì¢ Firebase pr√™t pour les tests');
            
            // Configurer l'√©couteur d'√©tat d'authentification
            window.firebase.onAuthStateChanged(window.firebase.auth, (user) => {
                console.log('üîÑ √âtat d\'authentification chang√©:', user ? user.email : 'd√©connect√©');
                
                if (user) {
                    const currentUserDiv = document.getElementById('currentUserStatus');
                    currentUserDiv.innerHTML = `
                        <div class="result success">
                            <p>üîÑ √âtat mis √† jour - Utilisateur connect√©: ${user.email}</p>
                        </div>
                    `;
                }
            });
        });
    </script>
</body>
</html>